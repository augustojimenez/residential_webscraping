---
title: "EDA: Housing Bella Vista, Santo Domingo"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r importing-data}
rm(list = ls())

options(scipen = 999)

library(tidyverse)
library(caret)

set.seed(1234)

path <- "../1_data/0_raw/housing price/"
housing_files <- list.files(path)
housing <- read_csv(paste0(path, housing_files))

housing <- housing %>%
  filter(date ==  "2022-03-22",
         province %in% c("Santo Domingo", "Santo Domingo Centro (D.N.)")) %>%
  select(-date) %>%
  mutate(across(.cols = c(seller:status, usage, planta:gimnasio, currency),
                factor)) %>%
  arrange(neighborhood) %>%
  unique()

inTrain <- createDataPartition(housing$price.usd, p = 0.7, list = FALSE)

training <- housing[inTrain, ]
testing <- housing[-inTrain, ]
```

```{r}
prices.dop <- training[training$currency == "RD$", ]$price
prices.usd <- training[training$currency == "US$", ]$price

ln.prices.dop <- log(prices.dop)
ln.prices.usd <- log(prices.usd)

cutoff.dop <- median(ln.prices.dop) + 2 * c(-1, 1) * mad(ln.prices.dop)
cutoff.usd <- median(ln.prices.usd) + 2 * c(-1, 1) * mad(ln.prices.usd)

training <- training %>%
  mutate(outlier = ifelse(currency == "RD$",
                          (log(price) < cutoff.dop[1]) | (log(price) > cutoff.dop[2]),
                          (log(price) < cutoff.usd[1]) | (log(price) > cutoff.usd[2])),
         area_spline = ifelse(area > 300,
                              TRUE,
                              FALSE)) %>%
  filter( outlier == FALSE,
          area < 600)

ggplot(training, aes(area, price.usd, colour = province)) +
  geom_point()

ggplot(training, aes(area, price.usd, colour = gimnasio)) +
  geom_point() +
  geom_smooth()

ggplot(training, aes(area, price.usd, colour = lobby)) +
  geom_point() +
  geom_smooth()

ggplot(training, aes(area, price.usd, colour = as.factor(parking))) +
  geom_point() +
  geom_smooth()

ggplot(training, aes(sqrt(area), log(price.usd), colour = as.factor(bedrooms))) +
  geom_point()

fit2 <- lm(price.usd ~ area*gimnasio + I(area^2)*gimnasio + neighborhood + status + parking*area,
          data = training)
summary(fit2)
fit <- lm(I(sqrt(price.usd)) ~ area * gimnasio + neighborhood + status + parking,
          data = training)
fit <- lm(log(price.usd) ~ log(area) * gimnasio + I(area^2) * gimnasio + neighborhood + status + parking + area_spline,
          data = training)
fit <- lm(log(price.usd) ~ log(area) * gimnasio + neighborhood + status + parking + area_spline,
          data = training)
fit <- lm(price.usd ~ area * gimnasio + neighborhood + status + parking + area_spline,
          data = training)
summary(fit)
shapiro.test(residuals(fit))

```



```{r}



housing %>%
    ggplot(aes(y = log(price.usd), x = area)) +
    geom_point() +
    geom_smooth()

housing %>%
    ggplot(aes(y = log(price.usd), fill = lift)) +
    geom_boxplot()

housing %>%
    ggplot(aes(y = log(price.usd), fill = pool)) +
    geom_boxplot()

housing %>%
    ggplot(aes(y = log(price.usd), fill = gimnasio)) +
    geom_boxplot()
```

```{r}
set.seed(123)
`%nin%` <- Negate(`%in%`)
housing <- housing %>%
    mutate(area2 = area^2,
           area.bedroom = area/bedrooms) %>%
    filter(area <= 600)

train <- sample(1:nrow(housing),
                 round(nrow(housing)) * 0.7)
test <- 1:nrow(housing) %nin% train

housing.train <- housing[train,]
housing.test <- housing[test,]

# Model 1
lm.fit1 = lm(formula = price.usd ~ area + area2 + parking + pool + gimnasio + balcon*area + 0,
             data = housing.train)
summary(lm.fit1)

# Model 2
lm.fit2 = lm(formula = log(price.usd) ~ area + parking + bedrooms + area*bathrooms + pool + gimnasio + balcon*area + 0,
             data = housing.train)
summary(lm.fit2)

# Model 3
lm.fit3 = lm(formula = price.usd ~ area + parking + pool + gimnasio + 0,
             data = housing.train)
summary(lm.fit3)

# Model 4
lm.fit4 = lm(formula = log(price.usd) ~ area + area2 + area*parking + area.bedroom + pool + gimnasio + balcon*area + 0,
             data = housing.train)
summary(lm.fit4)

# Evaluating fits
housing.test <- housing.test %>%
    mutate(fit1 = predict(lm.fit1, housing.test, interval = "confidence"),
           fit2 = exp(predict(lm.fit2, housing.test, interval = "confidence")),
           fit3 = predict(lm.fit3, housing.test, interval = "confidence"),
           fit4 = exp(predict(lm.fit4, housing.test, interval = "confidence")),
           er1 = (fit1 - price.usd)^2,
           er2 = (fit2 - price.usd)^2,
           er3 = (fit3 - price.usd)^2,
           er4 = (fit4 - price.usd)^2) %>%
    summarise(er1 = sum(er1, na.rm = TRUE),
              er2 = sum(er2, na.rm = TRUE),
              er3 = sum(er3, na.rm = TRUE),
              er4 = sum(er4, na.rm = TRUE)) %>%
    mutate(er1 = sqrt(er1),
           er2 = sqrt(er2),
           er3 = sqrt(er3),
           er4 = sqrt(er4))

torre <- read.csv("../source/Torre Carmen I.csv") %>%
    select(total.area, parking, bedrooms, pool, gimnasio, lobby, story) %>%
    rename(area = total.area) %>%
    mutate(area2 = area^2,
           balcon = TRUE,
           lobby = as.logical(lobby),
           pool = as.logical(pool),
           gimnasio = as.logical(gimnasio),
           status = 1) %>%
    mutate(price.usd = predict(lm.fit3, torre, interval = "confidence") * 1000)
write.csv(torre, "../data/precios.csv")
# Check variance inflation factor (VIF)
```